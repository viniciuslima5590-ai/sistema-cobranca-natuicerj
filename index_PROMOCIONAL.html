<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Cobran√ßa Log√≠stica Natuice - Processamento autom√°tico de notas fiscais">
    <title>WL Log√≠stica - Sistema Natuice</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöö</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 { 
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header p { 
            opacity: 0.95;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .company-name {
            font-size: 14px;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }
        .promo-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 700;
            margin-top: 15px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .content { padding: 40px; }
        .welcome-box {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-left: 4px solid #f59e0b;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        .welcome-box h2 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .welcome-box p {
            color: #92400e;
            line-height: 1.6;
        }
        .welcome-box strong {
            color: #ea580c;
        }
        .upload-section { 
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }
        .upload-section:hover { 
            background: #f0f2ff;
            border-color: #764ba2;
            transform: translateY(-2px);
        }
        .upload-section.dragover { 
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        .upload-section.processing { 
            background: #e0e7ff;
            border-color: #4f46e5;
            pointer-events: none;
        }
        .upload-icon { 
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .upload-section h2 { 
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .upload-section p { 
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }
        #fileInput { display: none; }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-block;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        .btn-success { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .btn-small { 
            padding: 10px 25px;
            font-size: 14px;
            margin: 5px;
        }
        .status-box { 
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }
        .status-box.show { display: block; }
        .status-box.error { 
            background: #fff5f5;
            border-left-color: #e53e3e;
        }
        .status-box.success { 
            background: #f0fff4;
            border-left-color: #38a169;
        }
        .loading { 
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-container { margin: 20px 0; }
        .progress-bar { 
            width: 100%;
            height: 35px;
            background: #e2e8f0;
            border-radius: 17px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill { 
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .file-list { 
            margin: 20px 0;
            max-height: 450px;
            overflow-y: auto;
        }
        .file-item { 
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .file-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }
        .file-item.processing { 
            background: #f0f9ff;
            border-color: #38bdf8;
        }
        .file-item.success { 
            background: #f0fdf4;
            border-color: #4ade80;
        }
        .file-item.error { 
            background: #fef2f2;
            border-color: #f87171;
        }
        .file-info { flex: 1; }
        .file-name { 
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .file-status { 
            font-size: 14px;
            color: #64748b;
        }
        .file-icon { 
            font-size: 32px;
            margin-right: 20px;
        }
        .file-actions { 
            display: flex;
            gap: 10px;
        }
        .summary { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .summary-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card h3 { 
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        .summary-card p { 
            font-size: 36px;
            font-weight: 700;
        }
        .instructions { 
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .instructions h3 { 
            color: #92400e;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .instructions ol { 
            margin-left: 25px;
            color: #78350f;
        }
        .instructions li { 
            margin: 10px 0;
            line-height: 1.6;
        }
        .info-badge { 
            display: inline-block;
            background: #4ade80;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
        }
        .footer {
            background: #f8fafc;
            padding: 25px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }
        .footer strong {
            color: #1e293b;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 28px; }
            .content { padding: 20px; }
            .upload-section { padding: 40px 20px; }
            .summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Sistema de Cobran√ßa Log√≠stica</h1>
            <p>Processamento Autom√°tico de Notas Fiscais - Natuice Sorvetes</p>
            <div class="promo-badge">üéâ PRE√áOS PROMOCIONAIS AT√â MAR√áO</div>
            <div class="company-name">WL Log√≠stica de Congelados</div>
            <span class="info-badge">‚úì Online | 230 Produtos</span>
        </div>
        
        <div class="content">
            <div class="welcome-box">
                <h2>üéä Tabela Promocional Ativa!</h2>
                <p><strong>ATEN√á√ÉO:</strong> Este sistema est√° utilizando a <strong>tabela de pre√ßos promocionais v√°lida at√© MAR√áO de 2026</strong>. Todos os c√°lculos ser√£o feitos com os valores promocionais!</p>
            </div>
            
            <div class="instructions">
                <h3>üìã Como usar o sistema:</h3>
                <ol>
                    <li><strong>Selecione os arquivos:</strong> Clique na √°rea abaixo ou arraste m√∫ltiplas notas fiscais (PDF ou XML)</li>
                    <li><strong>Processamento autom√°tico:</strong> O sistema extrai produtos e calcula com pre√ßos promocionais</li>
                    <li><strong>Planilhas profissionais:</strong> Excel formatado com valores em moeda e layout organizado</li>
                    <li><strong>Download individual ou em lote:</strong> Baixe uma por uma ou todas de uma vez</li>
                </ol>
            </div>
            
            <div>
                <h2 style="margin-bottom: 20px; color: #1e293b;">üìÑ Selecione as Notas Fiscais</h2>
                <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì¶</div>
                    <h2>Arraste os arquivos aqui ou clique para selecionar</h2>
                    <p>Aceita m√∫ltiplos PDFs e XMLs simultaneamente</p>
                    <input type="file" id="fileInput" accept=".pdf,.xml" multiple onchange="handleFileUpload(event)">
                </div>
            </div>
            
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
            
            <div id="status" class="status-box"></div>
            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div id="summary" style="display: none;">
                <h2 style="margin: 30px 0 20px 0; color: #1e293b;">üìä Resumo do Processamento</h2>
                <div class="summary">
                    <div class="summary-card">
                        <h3>Total de Notas</h3>
                        <p id="totalFiles">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Processadas ‚úì</h3>
                        <p id="successFiles">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Com Erro ‚úó</h3>
                        <p id="errorFiles">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total de Itens</h3>
                        <p id="totalItems">0</p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" id="downloadAllBtn" onclick="downloadAll()" disabled>
                        üì• Baixar Todas as Planilhas
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Processar Novas Notas
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <strong>WL Log√≠stica de Congelados</strong> - Sistema de Cobran√ßa Natuice<br>
            üéâ Pre√ßos Promocionais at√© Mar√ßo 2026 | Desenvolvido para automatizar processos ‚ö°
        </div>
    </div>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const priceTable = {
  "00000080": {
    "description": "POTE BRIGADEIRO 2L",
    "price": 4.639999999999999
  },
  "00000071": {
    "description": "POTE CHOCO NUT 2L",
    "price": 4.639999999999999
  },
  "00011688": {
    "description": "POTE CHOCOTONE 2L (EDI√á√ÉO LIMITADA)",
    "price": 4.639999999999999
  },
  "00000091": {
    "description": "POTE CHOCOTRUFA 2L",
    "price": 4.639999999999999
  },
  "00000084": {
    "description": "POTE CREME PARIS 2L",
    "price": 4.639999999999999
  },
  "00000085": {
    "description": "POTE FLOCOS 2L",
    "price": 4.639999999999999
  },
  "00000081": {
    "description": "POTE NINHO TRUFADO 2L",
    "price": 4.639999999999999
  },
  "00011612": {
    "description": "POTE PANETONE 2L (EDI√á√ÉO LIMITADA)",
    "price": 4.639999999999999
  },
  "00000090": {
    "description": "POTE PASSAS AO RUN 2L",
    "price": 4.639999999999999
  },
  "00000150": {
    "description": "POTE SUNDAE 2L",
    "price": 2.32
  },
  "00000094": {
    "description": "POTE TENTACAO 2L",
    "price": 2.32
  },
  "00000079": {
    "description": "POTE COCO 2L",
    "price": 4.379999999999999
  },
  "00000083": {
    "description": "POTE CREME 2L",
    "price": 4.379999999999999
  },
  "00000078": {
    "description": "POTE LEITE CONDENSADO 2L",
    "price": 1.7
  },
  "00000087": {
    "description": "POTE MILHO VERDE 2L",
    "price": 4.379999999999999
  },
  "00000088": {
    "description": "POTE MORANGO 2L",
    "price": 1.7
  },
  "00000282": {
    "description": "POTE CARIOCA 2L",
    "price": 4.379999999999999
  },
  "00000072": {
    "description": "POTE CHOCOLITANO 2L",
    "price": 4.379999999999999
  },
  "00011600": {
    "description": "POTE COPA DO MUNDO 2022 2L",
    "price": 4.379999999999999
  },
  "00000180": {
    "description": "POTE DUO MOUSSE 2L",
    "price": 4.379999999999999
  },
  "00000170": {
    "description": "POTE DUO TROPICAL 2L",
    "price": 4.379999999999999
  },
  "00000082": {
    "description": "POTE HAVAIANO 2L",
    "price": 2.19
  },
  "00000089": {
    "description": "POTE NAPOLITANO 2L",
    "price": 4.379999999999999
  },
  "00000178": {
    "description": "POTE CASADINHO 1,5 LITRO",
    "price": 3.4499999999999993
  },
  "00000181": {
    "description": "POTE MOUSSE MARACUJA 1,5L",
    "price": 3.4499999999999993
  },
  "00000177": {
    "description": "POTE PRIMAVERA 1,5L",
    "price": 3.4499999999999993
  },
  "00000126": {
    "description": "POTE FRUTAS VERMELHAS 1.5L",
    "price": 3.4499999999999993
  },
  "00000143": {
    "description": "POTE LIM√ÉO SICILIANO 1.5L",
    "price": 3.4499999999999993
  },
  "00000164": {
    "description": "POTE UVA 1.5L",
    "price": 3.4499999999999993
  },
  "00000341": {
    "description": "POTE NAPOLITANO ZERO 1,5L",
    "price": 10.82
  },
  "00000159": {
    "description": "POTE A√áAI GUARANA ZERO 5 LITROS",
    "price": 30.899999999999977
  },
  "00000288": {
    "description": "POTE NINHO TRUFADO ZERO 5 LITROS",
    "price": 30.899999999999977
  },
  "00000304": {
    "description": "POTE PISTACHE ZERO 5 LITROS",
    "price": 30.899999999999977
  },
  "00000064": {
    "description": "CUP CREAM BRIGADEIRO 320 ML 8 UN,",
    "price": 10.559999999999999
  },
  "00000086": {
    "description": "CUP CREAM CHOCOLITANO 320 ML 8 UN,",
    "price": 10.559999999999999
  },
  "00000067": {
    "description": "CUP CREAM FLOCOS 320 ML 8 UN.",
    "price": 10.559999999999999
  },
  "00000068": {
    "description": "CUP CREAM IOGURTE A. 320 ML 8 UN.",
    "price": 10.559999999999999
  },
  "00000073": {
    "description": "CUP CREAM NAPOLITANO 320 ML 8 UN.",
    "price": 10.559999999999999
  },
  "00000301": {
    "description": "GELATO BROWNIE 500ML 8 UNID",
    "price": 20.0
  },
  "00000299": {
    "description": "GELATO DOCE DE LEITE 500ML 8 UNID",
    "price": 20.0
  },
  "00000298": {
    "description": "GELATO MENTA CHOCO CHIP 500ML 8 UNID",
    "price": 20.0
  },
  "00000300": {
    "description": "GELATO PISTACHE 500ML 8 UNID",
    "price": 20.0
  },
  "00000201": {
    "description": "MINI M. CHOCOLATE T. 400 ML 8 UN.",
    "price": 16.72
  },
  "00000200": {
    "description": "MINI M. LEITINHO T. 400 ML 8 UN.",
    "price": 16.72
  },
  "00000125": {
    "description": "ESPECIAIS BRIGADEIRO 24 UNIDADES",
    "price": 30.0
  },
  "00000122": {
    "description": "ESPECIAIS NATUBARRA 24 UNIDADES",
    "price": 30.0
  },
  "00000129": {
    "description": "ESPECIAIS SKIMO 24 UNIDADES",
    "price": 30.0
  },
  "00000128": {
    "description": "ESPECIAIS TENTACAO 24 UNIDADES",
    "price": 30.0
  },
  "00000263": {
    "description": "MAGNIFICO BEIJINHO TRUFADO 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000179": {
    "description": "MAGNIFICO BEIJO CAIPIRA 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000264": {
    "description": "MAGNIFICO CAF√â TRUFADO 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000318": {
    "description": "MAGNIFICO CARAMELO SALGADO 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000265": {
    "description": "MAGNIFICO GREGO FRUTAS VER. 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000266": {
    "description": "MAGNIFICO PISTACHE 1.5 LITRO",
    "price": 4.120000000000001
  },
  "00000103": {
    "description": "PICOLE FRUTA ABACAXI 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000105": {
    "description": "PICOLE FRUTA ACAI 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000119": {
    "description": "PICOLE FRUTA AZULAO 28 UNIDADES",
    "price": 5.6
  },
  "00000120": {
    "description": "PICOLE FRUTA GROSELHA 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000111": {
    "description": "PICOLE FRUTA LIMAO 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000148": {
    "description": "PICOLE FRUTA MANGA 28 UNIDADES",
    "price": 5.6
  },
  "00000114": {
    "description": "PICOLE FRUTA MARACUJA 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000149": {
    "description": "PICOLE FRUTA MELANCIA 28 UNIDADES",
    "price": 5.6
  },
  "00000121": {
    "description": "PICOLE FRUTA TANGERINA 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000118": {
    "description": "PICOLE FRUTA UVA 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000188": {
    "description": "PICOLE FRUTA/LEITE MISTA 28 UNIDADES",
    "price": 10.919999999999998
  },
  "00000109": {
    "description": "PICOLE GOIABA 28 UNIDADES",
    "price": 5.6
  },
  "00000104": {
    "description": "PICOLE ABACAXI AO VINHO 28 UNIDADES",
    "price": 13.44
  },
  "00000190": {
    "description": "PICOLE CAPPUCCINO 28 UNIDADES",
    "price": 6.86
  },
  "00000106": {
    "description": "PICOLE CHOCOLATE 28 UNIDADES",
    "price": 13.44
  },
  "00000107": {
    "description": "PICOLE COCO BRANCO 28 UNIDADES",
    "price": 13.44
  },
  "00000108": {
    "description": "PICOLE COCO QUEIMADO 28 UNIDADES",
    "price": 13.44
  },
  "00000139": {
    "description": "PICOLE FLOCOS 28 UNIDADES",
    "price": 13.44
  },
  "00000110": {
    "description": "PICOLE LEITE CONDENSADO 28 UNIDADES",
    "price": 13.44
  },
  "00000138": {
    "description": "PICOLE LEITINHO 28 UNIDADES",
    "price": 13.44
  },
  "00000112": {
    "description": "PICOLE LIMAO SUICO 28 UNIDADES",
    "price": 6.86
  },
  "00000113": {
    "description": "PICOLE MAMAO PAPAYA 28 UNIDADES",
    "price": 13.44
  },
  "00000115": {
    "description": "PICOLE MILHO VERDE 28 UNIDADES",
    "price": 13.44
  },
  "00000116": {
    "description": "PICOLE MORANGO 28 UNIDADES",
    "price": 13.44
  },
  "00000325": {
    "description": "PICOLE NATUBALA 28 UNIDADES",
    "price": 6.86
  },
  "00000117": {
    "description": "PICOLE NATULULU 28 UNIDADES",
    "price": 13.44
  },
  "00000124": {
    "description": "PICOLE PACOCA 28 UNIDADES",
    "price": 6.86
  },
  "00000132": {
    "description": "ESPIRAL DRILL BANANA 24 UNIDADES",
    "price": 7.68
  },
  "00000131": {
    "description": "ESPIRAL DRILL CHOCO MENTA 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000095": {
    "description": "ESPIRAL DRILL CHOCONONE 24 UNIDADES",
    "price": 7.68
  },
  "00000096": {
    "description": "ESPIRAL DRILL LIMAO SUICO 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000097": {
    "description": "ESPIRAL DRILL PAMONHA 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000098": {
    "description": "ESPIRAL DRILL PUDIM 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000099": {
    "description": "ESPIRAL DRILL ROMEU E JULIETA 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000100": {
    "description": "ESPIRAL DRILL SEDUCAO 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000101": {
    "description": "ESPIRAL DRILL TENTACAO 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000102": {
    "description": "ESPIRAL DRILL TROPICAL 24 UNIDADES",
    "price": 15.120000000000003
  },
  "00000141": {
    "description": "MAGG BLACK 20 UN.",
    "price": 18.200000000000003
  },
  "00000230": {
    "description": "MAGG BRIGADEIRO 20 UN.",
    "price": 18.200000000000003
  },
  "00000223": {
    "description": "MAGG CHOCO COCO 20 UN.",
    "price": 9.2
  },
  "00000225": {
    "description": "MAGG CHOCOLATE AVELA 20 UN.",
    "price": 18.200000000000003
  },
  "00000224": {
    "description": "MAGG CHOCOLATE T. 20 UN.",
    "price": 18.200000000000003
  },
  "00000226": {
    "description": "MAGG CHOCOMENTA 20 UN.",
    "price": 9.2
  },
  "00000229": {
    "description": "MAGG CLASSICO (SKIMO) 20 UN.",
    "price": 18.200000000000003
  },
  "00000222": {
    "description": "MAGG COOKIES 20 UN.",
    "price": 18.200000000000003
  },
  "00000220": {
    "description": "MAGG FRUTAS VERM. 20 UN.",
    "price": 18.200000000000003
  },
  "00000219": {
    "description": "MAGG NINHO TRUFADO 20 UN.",
    "price": 18.200000000000003
  },
  "00000231": {
    "description": "MAGG PE DE MOLEQUE BR 20 UN.",
    "price": 18.200000000000003
  },
  "00000232": {
    "description": "MAGG PE DE MOLEQUE PR 20 UN.",
    "price": 18.200000000000003
  },
  "00000227": {
    "description": "MAGG PETIT GATEAU 20 UN.",
    "price": 18.200000000000003
  },
  "00000217": {
    "description": "MAGG PISTACHE 20 UNIDADES",
    "price": 10.999999999999996
  },
  "00011729": {
    "description": "MAGG RED VELVET 18 UN.",
    "price": 8.799999999999997
  },
  "00000130": {
    "description": "MAGG TORTA DE LIMAO 20 UN.",
    "price": 18.200000000000003
  },
  "00000142": {
    "description": "MAGG TRUFA 20 UN.",
    "price": 18.200000000000003
  },
  "00000221": {
    "description": "MAGG WHITE 20 UN.",
    "price": 18.200000000000003
  },
  "00000210": {
    "description": "MAGG CREAM 3 CHOCOLATES 20 UNID.",
    "price": 14.0
  },
  "00000214": {
    "description": "MAGG CREAM ALGODAO DOCE 20 UNID.",
    "price": 14.0
  },
  "00000238": {
    "description": "MAGG CREAM CORACAOZINHO 20 UNID.",
    "price": 14.0
  },
  "00000216": {
    "description": "MAGG CREAM FLOCOS 20 UNID.",
    "price": 7.0
  },
  "00000218": {
    "description": "MAGG CREAM GREGO MORANGO 20 UNID.",
    "price": 14.0
  },
  "00000209": {
    "description": "MAGG CREAM GREGO TRAD. 20 UNID.",
    "price": 14.0
  },
  "00000211": {
    "description": "MAGG CREAM M. DE CHOCOLATE 20 UNID.",
    "price": 7.0
  },
  "00000203": {
    "description": "MAGG CREAM M. DE COCO 20 UNID.",
    "price": 14.0
  },
  "00000204": {
    "description": "MAGG CREAM NAPOLITANO 20 UNID.",
    "price": 14.0
  },
  "00000361": {
    "description": "EXTRUSADO ACAI BANANA 22 UNIDADES",
    "price": 18.039999999999996
  },
  "00000362": {
    "description": "EXTRUSADO ACAI TRADICIONAL 22 UNIDADES",
    "price": 18.039999999999996
  },
  "00000228": {
    "description": "MAGG BROWNIE COM SORVETE 16 UN.",
    "price": 8.799999999999997
  },
  "00000251": {
    "description": "PALETA ACAI/LEITE CONDENSADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000310": {
    "description": "PALETA AMORA C LEITE CONDENSADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000193": {
    "description": "PALETA BANANA/CREME DE AVELA 22 UNID",
    "price": 35.42000000000001
  },
  "00000195": {
    "description": "PALETA CACAUTINE C/ CHOC TRUFADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000197": {
    "description": "PALETA CHOCOLATE BRANCO/CREME AVEL√É 22 UNID",
    "price": 35.42000000000001
  },
  "00000235": {
    "description": "PALETA COCO BRANCO 22 UNID",
    "price": 35.42000000000001
  },
  "00000234": {
    "description": "PALETA FLORESTA NEGRA 22 UNID",
    "price": 35.42000000000001
  },
  "00000196": {
    "description": "PALETA IOGURTE/FRUTAS VERMELHAS 22 UNID",
    "price": 35.42000000000001
  },
  "00000253": {
    "description": "PALETA LEITINHO CREME DE AVEL√É 22 UNID",
    "price": 35.42000000000001
  },
  "00000194": {
    "description": "PALETA LEITINHO TRUFADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000191": {
    "description": "PALETA MARACUJA/LEITE CONDENSADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000192": {
    "description": "PALETA MORANGO/LEITE CONDENSADO 22 UNID",
    "price": 35.42000000000001
  },
  "00000199": {
    "description": "PALETA PACOCA 22 UNID",
    "price": 35.42000000000001
  },
  "00000250": {
    "description": "PALETA CHOCO COCO 20 UNID",
    "price": 35.42000000000001
  },
  "00000233": {
    "description": "PALETA CHOCO DU 20 UNID",
    "price": 35.42000000000001
  },
  "00000249": {
    "description": "PALETA CHOCOTELA 20 UNIDADES",
    "price": 35.42000000000001
  },
  "00000074": {
    "description": "CONE CHOCOLATE 12 UNIDADES",
    "price": 20.160000000000007
  },
  "00011560": {
    "description": "CONE DEFEITO DE PRODU√á√ÉO 12 UNIDADES",
    "price": 20.160000000000007
  },
  "00000075": {
    "description": "CONE LEITINHO 12 UNIDADES",
    "price": 20.160000000000007
  },
  "00000076": {
    "description": "CONE TENTACAO 12 UNIDADES",
    "price": 20.160000000000007
  },
  "00000050": {
    "description": "SUNDAE BAUNILHA 8 UNIDADES",
    "price": 13.440000000000005
  },
  "00000049": {
    "description": "SUNDAE MORANGO 8 UNIDADES",
    "price": 13.440000000000005
  },
  "00000155": {
    "description": "ACAI COM GUARANA POTE 200 ML 10 UNID",
    "price": 19.499999999999993
  },
  "00011690": {
    "description": "ACAI COM GUARANA/GRANOLA POTE 220ML 10 UNID",
    "price": 19.5
  },
  "00000507": {
    "description": "ACAI BANANA 1,5L",
    "price": 6.149999999999999
  },
  "00011504": {
    "description": "ACAI COM IORGUTE GREGO 1,5L",
    "price": 6.149999999999999
  },
  "00011503": {
    "description": "ACAI COM LEITINHO 1.5L",
    "price": 6.149999999999999
  },
  "00000508": {
    "description": "ACAI GUARANA 1,5L",
    "price": 6.149999999999999
  },
  "00000509": {
    "description": "ACAI MORANGO 1,5L",
    "price": 6.149999999999999
  },
  "00000510": {
    "description": "ACAI TRADICIONAL 1,5L",
    "price": 6.149999999999999
  },
  "00000163": {
    "description": "ACAI COM GUARANA POTE 2 LITROS",
    "price": 8.24
  },
  "00000168": {
    "description": "ACAI COM BANANA  POTE 5 LITROS",
    "price": 36.86
  },
  "00000167": {
    "description": "ACAI COM GUARANA POTE 5 LITROS",
    "price": 36.86
  },
  "00000169": {
    "description": "ACAI COM MORANGO POTE 5 LITROS",
    "price": 36.86
  },
  "00000166": {
    "description": "ACAI TRADICIONAL  POTE 5 LITROS",
    "price": 36.86
  },
  "00000255": {
    "description": "CAIXA ACAI BANANA 10 LITROS",
    "price": 36.25
  },
  "00011527": {
    "description": "CAIXA ACAI COM CHOCOLATE BRANCO 10 LITROS",
    "price": 36.25
  },
  "00011524": {
    "description": "CAIXA ACAI COM CREME DE AVELA 10 LITROS",
    "price": 36.25
  },
  "00011525": {
    "description": "CAIXA ACAI COM IOGURTE GREGO 10 LITROS",
    "price": 36.25
  },
  "00011526": {
    "description": "CAIXA ACAI COM LEITINHO 10 LITROS",
    "price": 36.25
  },
  "00000247": {
    "description": "CAIXA ACAI GUARANA 10 LITROS",
    "price": 36.25
  },
  "00000254": {
    "description": "CAIXA ACAI MORANGO 10 LITROS",
    "price": 36.25
  },
  "00011452": {
    "description": "CAIXA ACAI TESTE",
    "price": 36.25
  },
  "00000162": {
    "description": "CAIXA ACAI TRADICIONAL 10 LITROS",
    "price": 36.25
  },
  "00011523": {
    "description": "CAIXA ACAI TRUFADO 10 LITROS",
    "price": 36.25
  },
  "00000001": {
    "description": "CAIXA ABACAXI 10 LITROS",
    "price": 33.989999999999995
  },
  "00000013": {
    "description": "CAIXA CEU AZUL 10 LITROS",
    "price": 33.989999999999995
  },
  "00000005": {
    "description": "CAIXA CHICLETES 10 LITROS",
    "price": 33.989999999999995
  },
  "00000014": {
    "description": "CAIXA COCO BRANCO 10 LITROS",
    "price": 33.989999999999995
  },
  "00000015": {
    "description": "CAIXA CREME 10 LITROS",
    "price": 33.989999999999995
  },
  "00000340": {
    "description": "CAIXA CUPUACU 10 LITROS",
    "price": 34.150000000000006
  },
  "00000027": {
    "description": "CAIXA LEITE CONDENSADO 10 LITROS",
    "price": 33.989999999999995
  },
  "00000029": {
    "description": "CAIXA LIMAO SUICO 10 LITROS",
    "price": 33.989999999999995
  },
  "00000033": {
    "description": "CAIXA MILHO VERDE 10 LITROS",
    "price": 33.989999999999995
  },
  "00000034": {
    "description": "CAIXA MORANGO 10 LITROS",
    "price": 33.989999999999995
  },
  "00000036": {
    "description": "CAIXA MOUSSE DE UVA 10 LITROS",
    "price": 33.989999999999995
  },
  "00000048": {
    "description": "CAIXA TORTA DE LIMAO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000332": {
    "description": "GELATINHO CUPUACU 28 UNIDADES",
    "price": 0.0
  },
  "00000336": {
    "description": "GELATINHO KIWI 28 UNIDADES",
    "price": 0.0
  },
  "00000337": {
    "description": "GELATINHO MORANGO 28 UNIDADES",
    "price": 0.0
  },
  "00000338": {
    "description": "GELATINHO MORANGO/AMORA 28 UNIDADES",
    "price": 0.0
  },
  "00000002": {
    "description": "CAIXA ABACAXI AO VINHO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000174": {
    "description": "CAIXA AMENDOIM 10 LITROS",
    "price": 19.049999999999997
  },
  "00000038": {
    "description": "CAIXA BAUNILHA 10 LITROS",
    "price": 33.989999999999995
  },
  "00000006": {
    "description": "CAIXA BRIGADEIRO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000003": {
    "description": "CAIXA CAF√â 10 LITROS",
    "price": 19.049999999999997
  },
  "00000279": {
    "description": "CAIXA CARAMELO SALGADO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000007": {
    "description": "CAIXA CEREJA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000296": {
    "description": "CAIXA CHOCO TELLA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000009": {
    "description": "CAIXA CHOCO TRUFA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000010": {
    "description": "CAIXA CHOCOLATE 10 LITROS",
    "price": 19.049999999999997
  },
  "00011577": {
    "description": "CAIXA CHOCOLATE B. C/ DOCE DE LEITE 10 LITROS",
    "price": 19.049999999999997
  },
  "00000011": {
    "description": "CAIXA CHOCOMENTA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000016": {
    "description": "CAIXA CREME DE PARIS 10 LITROS",
    "price": 19.049999999999997
  },
  "00000020": {
    "description": "CAIXA DIAMANTE NEGRO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000051": {
    "description": "CAIXA DOCE DE LEITE 10 LITROS",
    "price": 19.049999999999997
  },
  "00000022": {
    "description": "CAIXA FERRERO ROCHER 10 LITROS",
    "price": 19.049999999999997
  },
  "00000023": {
    "description": "CAIXA FLOCOS 10 LITROS",
    "price": 19.049999999999997
  },
  "00000024": {
    "description": "CAIXA FRUTAS DO BOSQUE 10 LITROS",
    "price": 19.049999999999997
  },
  "00000025": {
    "description": "CAIXA IOGURTE COM AMORA 10 LITROS",
    "price": 19.049999999999997
  },
  "00011582": {
    "description": "CAIXA IORGUTE AMARENA 10 LITROS",
    "price": 19.049999999999997
  },
  "00011702": {
    "description": "CAIXA KINDER OVO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000026": {
    "description": "CAIXA LACTA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000028": {
    "description": "CAIXA LAMBADA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000035": {
    "description": "CAIXA MOUSSE DE MARACUJA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000037": {
    "description": "CAIXA NAPOLITANO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000008": {
    "description": "CAIXA NINHO C/ NUTELLA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000171": {
    "description": "CAIXA NINHO TRUFADO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000052": {
    "description": "CAIXA OVOMALTINE 10 LITROS",
    "price": 19.049999999999997
  },
  "00000040": {
    "description": "CAIXA PASSAS AO RUN 10 LITROS",
    "price": 19.049999999999997
  },
  "00000047": {
    "description": "CAIXA PAVE ITALIANO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000041": {
    "description": "CAIXA PISTACHE 10 LITROS",
    "price": 19.049999999999997
  },
  "00000042": {
    "description": "CAIXA PRESTIGIO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000044": {
    "description": "CAIXA SONHO DE VALSA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000043": {
    "description": "CAIXA TENTACAO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000046": {
    "description": "CAIXA TORTA ALEMA 10 LITROS",
    "price": 19.049999999999997
  },
  "00000030": {
    "description": "CAIXA UNICORNIO 10 LITROS",
    "price": 19.049999999999997
  },
  "00000363": {
    "description": "GOSTOSINHO CHOCOLATE 50 UN.",
    "price": 19.0
  },
  "00000366": {
    "description": "GOSTOSINHO COCO 50 UN.",
    "price": 19.0
  },
  "00000365": {
    "description": "GOSTOSINHO LEITE CONDENSADO 50 UN.",
    "price": 19.0
  },
  "00000367": {
    "description": "GOSTOSINHO MARACUJA 50 UN.",
    "price": 19.0
  },
  "00000369": {
    "description": "GOSTOSINHO MISTO 50 UN.",
    "price": 19.0
  },
  "00000364": {
    "description": "GOSTOSINHO MORANGO 50 UN.",
    "price": 19.0
  },
  "00000368": {
    "description": "GOSTOSINHO UNICORNIO 50 UN.",
    "price": 19.0
  },
  "00000360": {
    "description": "A√áAIZINHO TRADICIONAL 50 UND.",
    "price": 15.499999999999996
  },
  "00011719": {
    "description": "BOMBOM ACAI CHOC BRANCO CX 12 UNIDADES",
    "price": 31.319999999999993
  },
  "00000258": {
    "description": "BOMBOM SKIMO CX 12 UNIDADES",
    "price": 31.319999999999993
  },
  "00000256": {
    "description": "BOMBOM TENTACAO CX 12 UNIDADES",
    "price": 31.319999999999993
  },
  "00011825": {
    "description": "TWIST UNICORNIO ",
    "price": 1.5
  }
};
        
        let processedFiles = [];
        let totalFiles = 0;
        let successCount = 0;
        let errorCount = 0;
        let totalItemsCount = 0;
        
        const uploadSection = document.getElementById('uploadSection');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadSection.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
        ['dragenter', 'dragover'].forEach(e => uploadSection.addEventListener(e, () => uploadSection.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(e => uploadSection.addEventListener(e, () => uploadSection.classList.remove('dragover'), false));
        uploadSection.addEventListener('drop', (e) => { const f = e.dataTransfer.files; if (f.length) { document.getElementById('fileInput').files = f; handleFileUpload({ target: { files: f } }); } }, false);
        
        function showStatus(type, msg) { const s = document.getElementById('status'); s.className = `status-box show ${type}`; s.innerHTML = msg; }
        
        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = `${current}/${total} - ${percent}%`;
        }
        
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            totalFiles = files.length;
            processedFiles = [];
            successCount = 0;
            errorCount = 0;
            totalItemsCount = 0;
            
            uploadSection.classList.add('processing');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('fileList').style.display = 'block';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            showStatus('', `<span class="loading"></span> Processando ${totalFiles} nota(s) fiscal(is) com pre√ßos promocionais...`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress(i, totalFiles);
                await processFile(file, i);
            }
            
            updateProgress(totalFiles, totalFiles);
            finishProcessing();
        }
        
        async function processFile(file, index) {
            const fileId = `file-${index}`;
            const fileName = file.name;
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item processing';
            fileItem.id = fileId;
            fileItem.innerHTML = `
                <div class="file-icon">‚è≥</div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-status">Processando...</div>
                </div>
                <div class="file-actions"></div>
            `;
            document.getElementById('fileList').appendChild(fileItem);
            
            try {
                const isXML = fileName.toLowerCase().endsWith('.xml');
                const result = isXML ? await processXML(file) : await processPDF(file);
                
                if (result.success && result.data.length > 0) {
                    fileItem.className = 'file-item success';
                    fileItem.querySelector('.file-icon').textContent = '‚úÖ';
                    fileItem.querySelector('.file-status').textContent = `${result.data.length} produtos extra√≠dos`;
                    
                    const excelData = {
                        nfInfo: result.nfInfo,
                        data: result.data,
                        fileName: generateFileName(result.nfInfo),
                        index: index
                    };
                    
                    processedFiles.push(excelData);
                    
                    const actionsDiv = fileItem.querySelector('.file-actions');
                    actionsDiv.innerHTML = `<button class="btn btn-success btn-small" onclick="downloadSingle(${index})">üì• Baixar</button>`;
                    
                    successCount++;
                    totalItemsCount += result.data.length;
                } else {
                    throw new Error('Nenhum produto encontrado');
                }
                
            } catch (error) {
                fileItem.className = 'file-item error';
                fileItem.querySelector('.file-icon').textContent = '‚ùå';
                fileItem.querySelector('.file-status').textContent = `Erro: ${error.message}`;
                errorCount++;
            }
        }
        
        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let allText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const items = textContent.items.sort((a, b) => {
                    const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                    if (yDiff < 2) return a.transform[4] - b.transform[4];
                    return b.transform[5] - a.transform[5];
                });
                let pageText = '';
                let lastY = null;
                for (const item of items) {
                    const y = item.transform[5];
                    if (lastY !== null && Math.abs(y - lastY) > 2) pageText += '\n';
                    pageText += item.str + ' ';
                    lastY = y;
                }
                allText += pageText + '\n';
            }
            
            return parseInvoiceData(allText);
        }
        
        async function processXML(file) {
            const text = await file.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const nfeProc = xmlDoc.getElementsByTagName('nfeProc')[0] || xmlDoc;
            const ide = nfeProc.getElementsByTagName('ide')[0];
            const dest = nfeProc.getElementsByTagName('dest')[0];
            
            const nfInfo = {
                number: ide ? getXMLValue(ide, 'nNF') : 'N/A',
                client: dest ? getXMLValue(dest, 'xNome') : 'N/A',
                cnpj: dest ? formatCNPJ(getXMLValue(dest, 'CNPJ')) : 'N/A',
                date: ide ? formatDate(getXMLValue(ide, 'dhEmi')) : 'N/A'
            };
            
            const data = [];
            const dets = nfeProc.getElementsByTagName('det');
            for (let det of dets) {
                const prod = det.getElementsByTagName('prod')[0];
                if (!prod) continue;
                const code = getXMLValue(prod, 'cProd').padStart(8, '0');
                const description = getXMLValue(prod, 'xProd');
                const quantity = parseFloat(getXMLValue(prod, 'qCom'));
                const unit = getXMLValue(prod, 'uCom');
                const priceInfo = priceTable[code];
                if (priceInfo) {
                    data.push({
                        code, description, quantity, unit,
                        unitPrice: priceInfo.price,
                        totalPrice: quantity * priceInfo.price
                    });
                }
            }
            
            return { success: true, nfInfo, data };
        }
        
        function getXMLValue(element, tagName) { const tag = element.getElementsByTagName(tagName)[0]; return tag ? tag.textContent : ''; }
        function formatDate(dateStr) { if (!dateStr) return 'N/A'; const d = new Date(dateStr); return d.toLocaleDateString('pt-BR').replace(/\//g, '-'); }
        function formatCNPJ(cnpj) { if (!cnpj || cnpj.length !== 14) return cnpj; return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5'); }
        
        function parseInvoiceData(text) {
            const nfMatch = text.match(/N¬∫\s*(\d+\.\d+\.\d+)/);
            const clientMatch = text.match(/Nome\/Raz√£o Social.*?\n(.+?)\s+\d{2}\.\d{3}/s) || text.match(/DESTINAT√ÅRIO.*?\n.*?\n(.+?)\s+\d{2}\.\d{3}/s);
            const dateMatch = text.match(/Data Emiss√£o:\s*(\d{2}\/\d{2}\/\d{4})/);
            const cnpjMatch = text.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
            
            const nfInfo = {
                number: nfMatch ? nfMatch[1].replace(/\./g, '') : 'N/A',
                client: clientMatch ? clientMatch[1].trim() : 'N/A',
                date: dateMatch ? dateMatch[1].replace(/\//g, '-') : 'N/A',
                cnpj: cnpjMatch ? cnpjMatch[1] : 'N/A'
            };
            
            const productsMap = new Map();
            const lines = text.split('\n');
            
            for (let line of lines) {
                const codeMatch = /\b(\d{8})\b/.exec(line);
                if (!codeMatch) continue;
                const code = codeMatch[1];
                const priceInfo = priceTable[code];
                if (!priceInfo) continue;
                const qtyMatch = /\b(UN|SC|CX|KG|LT|PC)\s+([\d,]+)/i.exec(line);
                if (!qtyMatch) continue;
                const unit = qtyMatch[1];
                const quantity = parseFloat(qtyMatch[2].replace(',', '.'));
                
                if (productsMap.has(code)) {
                    productsMap.get(code).quantity += quantity;
                } else {
                    const descMatch = new RegExp(code + '\\s+(.+?)\\s+\\d{8}').exec(line);
                    const description = descMatch ? descMatch[1].trim() : priceInfo.description;
                    productsMap.set(code, { code, description, quantity, unit, unitPrice: priceInfo.price });
                }
            }
            
            const data = [];
            productsMap.forEach((item) => {
                data.push({
                    code: item.code,
                    description: item.description,
                    quantity: item.quantity,
                    unit: item.unit,
                    unitPrice: item.unitPrice,
                    totalPrice: item.quantity * item.unitPrice
                });
            });
            
            return { success: data.length > 0, nfInfo, data };
        }
        
        function generateFileName(nfInfo) {
            const client = nfInfo.client.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 40);
            const number = nfInfo.number.replace(/[^0-9]/g, '');
            const date = nfInfo.date.replace(/[^0-9-]/g, '');
            return `${client}_NF${number}_${date}_PROMO.xlsx`;
        }
        
        function createExcelFile(fileData) {
            const wb = XLSX.utils.book_new();
            const data = [
                ['COBRAN√áA LOG√çSTICA - NATUICE SORVETES'], 
                ['üéâ PRE√áOS PROMOCIONAIS AT√â MAR√áO 2026'],
                [''],
                ['NF N√∫mero:', fileData.nfInfo.number],
                ['Cliente:', fileData.nfInfo.client],
                ['CNPJ:', fileData.nfInfo.cnpj],
                ['Data Emiss√£o:', fileData.nfInfo.date], [''],
                ['DISCRIMINATIVO DA COBRAN√áA LOG√çSTICA'], [''],
                ['C√≥digo', 'Descri√ß√£o do Produto', 'Quantidade', 'Unidade', 'Pre√ßo Unit. Log√≠stica (R$)', 'Valor Total Log√≠stica (R$)']
            ];
            
            let totalValue = 0;
            const startRow = 10;
            fileData.data.forEach(item => {
                data.push([item.code, item.description, item.quantity, item.unit, item.unitPrice, item.totalPrice]);
                totalValue += item.totalPrice;
            });
            
            data.push(['']);
            data.push(['', '', '', '', 'TOTAL GERAL:', totalValue]);
            data.push(['']);
            data.push(['Observa√ß√µes:']);
            data.push(['Este documento refere-se exclusivamente √† cobran√ßa dos servi√ßos log√≠sticos.']);
            data.push(['Valores calculados com base na TABELA PROMOCIONAL v√°lida at√© Mar√ßo de 2026.']);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            ws['!cols'] = [
                { wch: 12 }, { wch: 50 }, { wch: 12 }, { wch: 10 }, { wch: 28 }, { wch: 28 }
            ];
            
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
                { s: { r: 1, c: 0 }, e: { r: 1, c: 5 } },
                { s: { r: 8, c: 0 }, e: { r: 8, c: 5 } }
            ];
            
            const endRow = startRow + fileData.data.length - 1;
            const totalRow = endRow + 2;
            
            for (let row = startRow; row <= endRow; row++) {
                const cellE = XLSX.utils.encode_cell({ r: row, c: 4 });
                if (ws[cellE]) {
                    ws[cellE].z = 'R$ #,##0.00';
                    ws[cellE].t = 'n';
                }
            }
            
            for (let row = startRow; row <= endRow; row++) {
                const cellF = XLSX.utils.encode_cell({ r: row, c: 5 });
                if (ws[cellF]) {
                    ws[cellF].z = 'R$ #,##0.00';
                    ws[cellF].t = 'n';
                }
            }
            
            const totalCell = XLSX.utils.encode_cell({ r: totalRow, c: 5 });
            if (ws[totalCell]) {
                ws[totalCell].z = 'R$ #,##0.00';
                ws[totalCell].t = 'n';
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Cobran√ßa Log√≠stica');
            
            return wb;
        }
        
        function downloadSingle(index) {
            const fileData = processedFiles.find(f => f.index === index);
            if (!fileData) return;
            
            const wb = createExcelFile(fileData);
            XLSX.writeFile(wb, fileData.fileName);
        }
        
        function downloadAll() {
            showStatus('', '<span class="loading"></span> Baixando todas as planilhas...');
            
            let downloaded = 0;
            const total = processedFiles.length;
            
            const downloadNext = (i) => {
                if (i >= total) {
                    showStatus('success', `‚úÖ ${total} planilha(s) com pre√ßos promocionais baixada(s) com sucesso!`);
                    return;
                }
                
                const fileData = processedFiles[i];
                const wb = createExcelFile(fileData);
                XLSX.writeFile(wb, fileData.fileName);
                
                downloaded++;
                showStatus('', `<span class="loading"></span> Baixando ${downloaded}/${total}...`);
                
                setTimeout(() => downloadNext(i + 1), 500);
            };
            
            downloadNext(0);
        }
        
        function finishProcessing() {
            uploadSection.classList.remove('processing');
            
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('successFiles').textContent = successCount;
            document.getElementById('errorFiles').textContent = errorCount;
            document.getElementById('totalItems').textContent = totalItemsCount;
            document.getElementById('summary').style.display = 'block';
            
            if (successCount > 0) {
                showStatus('success', `‚úÖ Processamento conclu√≠do! ${successCount} nota(s) pronta(s) com pre√ßos promocionais.`);
                document.getElementById('downloadAllBtn').disabled = false;
            } else {
                showStatus('error', '‚ùå Nenhuma nota foi processada com sucesso.');
            }
        }
        
        function resetForm() {
            processedFiles = [];
            totalFiles = 0;
            successCount = 0;
            errorCount = 0;
            totalItemsCount = 0;
            document.getElementById('fileInput').value = '';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('status').className = 'status-box';
            uploadSection.classList.remove('processing');
        }
        
        window.onload = () => {
            console.log(`Sistema WL Log√≠stica PROMOCIONAL carregado! ${Object.keys(priceTable).length} produtos - V√°lido at√© Mar√ßo 2026.`);
        };
    </script>
</body>
</html>